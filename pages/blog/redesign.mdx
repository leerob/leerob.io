---
title: 'Using MDX with Next.js'
publishedAt: '2020-03-25'
summary: 'Redesign'
image: '/static/images/redesign/banner.png'
---

Before my blog posts ranged from 1kb to 12kb in size, all with ~250kb first load. In total, there was 82kb shared by all files.

| Page |   Size    | First Load |
| :--- | :-------: | ---------: |
| `/`  | `3.86 kB` |   `104 kB` |

## Improved Content Management

I wanted to decrease the amount of friction it took to create new articles as well as improve maintainability
over time.

Previously, I maintained a JSON file containing all my articles.

```js:data/articles.json
export default [
  {
    date: 'February 24, 2020',
    slug: 'fetching-data-with-swr',
    title: 'Create a Dashboard with Next.js API Routes - Fetching Data with SWR'
  },
  {
    date: 'February 18, 2020',
    slug: 'google-analytics-api-nextjs',
    title: 'Create a Dashboard with Next.js API Routes - Google Analytics API'
  }
];
```

Then, I iterated over this list to display all articles when viewing `leerob.io/blog`. This worked, but it meant that
I had two sources of truth.

Each `.mdx` blog post already contained this information, as well as other metadata passed to `<Post />`.
Every time I added a new article, I had to change two places.

```js
export const meta = {
  date: '2019-12-26',
  description: 'Highlights and reflections on 2019 and a look forward to 2020.',
  image: '/static/images/2019/banner.jpg',
  slug: '2019',
  title: '2019 Year in Review'
};

export default ({ children }) => <Post meta={meta}>{children}</Post>;
```

We can do better. I decided to use [next-mdx-enhanced](https://github.com/hashicorp/next-mdx-enhanced) for
front matter and layout support. Now, each `.mdx` file looks like this:

```js
---
title: '2019 Year in Review'
publishedAt: '2019-12-26'
summary: 'Highlights and reflections on 2019 and a look forward to 2020.'
image: '/static/images/2019/banner.jpg'
---
```

You'll notice I removed `slug`. That's because I'm able to dynamically retrieve the value using
[next-mdx-enhanced](https://github.com/hashicorp/next-mdx-enhanced) inside the layout.
Anything added to your front matter will be converted into an object passed to the layout.

```js{5,6,7}:layouts/index.js
import React from 'react';

export default (frontMatter) => {
  return ({ children }) => {
    const slug = frontMatter.__resourcePath
      .replace('blog/', '')
      .replace('.mdx', '');

    return (
      <>
        <h1>{frontMatter.title}</h1>
        {children}
      </>
    );
  };
};
```

Thanks to [babel-plugin-import-glob-array](https://github.com/jescalan/babel-plugin-import-glob-array), I can make the file system
the source of truth.

```js:pages/blog.js
import { frontMatter as blogPosts } from './blog/**/*.mdx';

const Blog = () => (
    blogPosts.map((frontMatter) => (
        <BlogPost key={frontMatter.title} {...frontMatter} />
    ))}
);
```

## MDX Plugins

MDX uses [remark](https://github.com/remarkjs/remark) and [rehype](https://github.com/rehypejs/rehype) under the hood, and allows you to provide external plugins to hook into the compilation process.
Some of the plugins I added were:

- [remark-autolink-headings](https://github.com/remarkjs/remark-autolink-headings)
- [remark-slug](https://github.com/remarkjs/remark-slug)
- [remark-code-titles](https://github.com/mottox2/remark-code-titles)
- [remark-capitalize](https://github.com/zeit/remark-capitalize)

This gave me some really neat features I had wanted.

- Hover over a heading and click on `#` to link directly to it.
- Use `language:title` to add titles to code snippets.
- Run [zeit/title](https://github.com/zeit/title) over headings to auto-capitalize based on [The Chicago Manual of Style](https://www.chicagomanualofstyle.org/home.html).

## Better Syntax Highlighting

Previously, I directly imported a `prism.css` theme alongside `react-syntax-highlighter` to provide syntax highlighting.
This did not allow me to easily change styles based on the theme. Thus, the code style was always dark mode.

Instead, I switched to [mdx-prism](https://github.com/j0lv3r4/mdx-prism) (which is a fork of `@mapbox/rehype-prism`)
and created two prism themes for dark/light mode.

```js:styles/prism.js
import { css } from '@emotion/core';
import { theme } from '@chakra-ui/core';

const prismBaseTheme = css``;

export const prismLightTheme = css`
  \${prismBaseTheme};
`;

export const prismDarkTheme = css`
  \${prismBaseTheme};
`;
```

```js:_app.js
const { colorMode } = useColorMode();
const prismTheme = colorMode === 'light' ? prismLightTheme : prismDarkTheme;
```

which adds line highlighting capabilities.
